@model Provider

<div>
    <label for="statusDropdown">Select Status</label>
    <select id="statusDropdown" name="selectedStatus" onchange="filterRequests()">
        <option value="">---- Select Status ----</option>
        @foreach (var status in ViewBag.StatusList)
        {
            <option value="@status.Value">@status.Text</option>
        }
    </select>
</div>
<div>
    <button onclick="resetFilters()">Show All Requests</button>
</div>
<div>
    <h4>Request History</h4>
    <div id="requestHistory"></div>
</div>
<div>
    <button id="prevPage" onclick="prevPage()" disabled>Previous</button>
    <span id="pageInfo">Page 1</span>
    <button id="nextPage" onclick="nextPage()">Next</button>
</div>


<script>
    let currentPage = 1;
    const pageSize = 6;

    document.addEventListener("DOMContentLoaded", function () {
        resetFilters();
    });

    function resetFilters() {
        document.getElementById("statusDropdown").value = "";
        currentPage = 1; // Reset to the first page
        filterRequests();
    }

    function filterRequests() {
        var selectedStatus = document.getElementById("statusDropdown").value;
        var providerId = '@Model.Id';

        $.ajax({
            url: '/RequestHistory/FilterRequests',
            type: 'POST',
            data: { providerId: providerId, selectedStatus: selectedStatus, page: currentPage, pageSize: pageSize },
            success: function (response) {
                var requestHistoryDiv = document.getElementById("requestHistory");
                requestHistoryDiv.innerHTML = "";
                const { filteredRequests, totalRequests } = response;

                if (filteredRequests.length > 0) {
                    filteredRequests.forEach(function (request) {
                        let statusContent;
                        if (request.statusName === "on_Review") {
                            statusContent = `<button onclick="cancelRequest(${request.requestId})" class="btn btn-warning">Cancel</button>
                                             <button onclick="AcceptRequest(${request.requestId})" class="btn btn-warning">Accept</button>`;
                        } else if (request.statusName === "Completed") {
                            statusContent = `<span class="status-circle completed">Completed</span>`;
                        } else if (request.statusName === "Accepted") {
                            statusContent = `<span class="status-circle accepted">Accepted</span>
                                             <button onclick="CompleteRequest(${request.requestId})" class="btn btn-warning">Done</button>`;
                        }

                        let commentString = request.comment ? `<p>Comment: ${request.comment}</p>` : `<p>Comment: No Comment</p>`;
                        requestHistoryDiv.innerHTML += `
                            <div class="card" style="width: 18rem; margin: 10px;">
                                <div class="card-body">
                                    <h5 class="card-title">Customer: ${request.customerName}</h5>
                                    <p>Address: ${request.customerAddress}</p>
                                    <p>Phone: ${request.customerPhone}</p>
                                    <p>Request Date: ${request.requestDate}</p>
                                    <p>Preferred Communication: ${request.preferredCommunication}</p>
                                    ${commentString}
                                    ${statusContent}
                                </div>
                            </div>`;
                    });
                } else {
                    requestHistoryDiv.innerHTML = "<p>No request history available.</p>";
                }

                // Update pagination
                const totalPages = Math.ceil(totalRequests / pageSize);
                document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${totalPages}`;
                document.getElementById("prevPage").disabled = currentPage === 1;
                document.getElementById("nextPage").disabled = currentPage === totalPages;
            }
        });
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            filterRequests();
        }
    }

    function nextPage() {
        currentPage++;
        filterRequests();
    }

</script>