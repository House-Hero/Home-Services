@model Provider
@{
    Layout = "_CustomerProfileLayout";
}

<div class="container">
    <div class="title">
        <p>سجل الطلبات</p>
    </div>

    <div class="sorting">
        <div class="dropdown">
            <select id="statusDropdown" name="selectedStatus" onchange="filterRequests()">
                <option value="" selected disabled hidden>حالة الطلب</option>
                @foreach (var status in ViewBag.StatusList)
                {
                    <option value="@status.Value">@status.Text</option>
                }
            </select>
        </div>
    </div>

    <button onclick="resetFilters()" class="submit">عرض الطلبات</button>

    <div class="cards" id="requestHistory">
    </div>

    <div class="paging">
        <button id="prevPage" onclick="prevPage()" disabled>السابق</button>
        <span id="pageInfo">صفحة 1</span>
        <button id="nextPage" onclick="nextPage()">التالي</button>
    </div>
</div>

<script>
    let currentPage = 1;
    const pageSize = 6;

    document.addEventListener("DOMContentLoaded", function () {
        resetFilters();
    });

    function resetFilters() {
        document.getElementById("statusDropdown").value = "";
        currentPage = 1; // Reset to the first page
        filterRequests();
    }

    function filterRequests() {
        var selectedStatus = document.getElementById("statusDropdown").value;
        var providerId = '@Model.Id';

        $.ajax({
            url: '/RequestHistory/FilterRequests',
            type: 'POST',
            data: { providerId: providerId, selectedStatus: selectedStatus, page: currentPage, pageSize: pageSize },
            success: function (response) {
                var requestHistoryDiv = document.getElementById("requestHistory");
                requestHistoryDiv.innerHTML = "";
                const { filteredRequests, totalRequests } = response;

                if (filteredRequests.length > 0) {
                    filteredRequests.forEach(function (request) {
                        let statusContent;
                        if (request.statusName === "on_Review") {
                            statusContent = `<button onclick="cancelRequest(${request.requestId})" class="refuse">الغاء</button>
                                             <button onclick="AcceptRequest(${request.requestId})" class="accept">اوافق</button>`;
                        } else if (request.statusName === "Completed") {
                            statusContent = `<span class="done">اكتملت</span>`;
                        } else if (request.statusName === "Accepted") {
                            statusContent = `<span class="accepted">تم القبول</span>
                                             <button onclick="CompleteRequest(${request.requestId})" class="accept">اضغط لإكمال الخدمة</button>`;
                        }

                        let commentString = request.comment ? `<p>${request.comment}</p>` : `<p>لا يوجد تعليق</p>`;
                        requestHistoryDiv.innerHTML += `
                            <div class="card">
                                <div class="card-top-side">
                                    <div class="card-info">
                                        <h6>${request.customerName}</h6>
                                        <p>${request.preferredCommunication}</p>
                                    </div>
                                </div>
                                <div class="description">
                                        <p>تاريخ الطلب : ${request.requestDate} </p>
                                </div>
                                <div class="comment">
                                     ${commentString}
                                </div>
                                <div class="state-check">
                                        ${statusContent}
                                </div>
                                </div>`;
                    });
                } else {
                    requestHistoryDiv.innerHTML = "<p>لا يوجد طلبات متاحة</p>";
                }

                // Update pagination
                const totalPages = Math.ceil(totalRequests / pageSize);
                document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${totalPages}`;
                document.getElementById("prevPage").disabled = currentPage === 1;
                document.getElementById("nextPage").disabled = currentPage === totalPages;
            }
        });
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            filterRequests();
        }
    }

    function nextPage() {
        currentPage++;
        filterRequests();
    }

    function cancelRequest(requestId) {
        $.ajax({
            url: '/RequestHistory/CancelRequest',
            type: 'POST',
            data: { requestId: requestId },
            success: function () {
                alert("تم الغاء الطلب بنجاح.");
                filterRequests(); // Refresh the list
            },
            error: function () {
                alert("There was an error canceling the request.");
            }
        });
    }
    function AcceptRequest(requestId) {
        $.ajax({
            url: '/RequestHistory/AcceptRequest',
            type: 'POST',
            data: { requestId: requestId },
            success: function () {
                alert("تم قبول الطلب بنجاح.");
                filterRequests(); // Refresh the list
            },
            error: function () {
                alert("There was an error Accepting the request.");
            }
        });
    }
    function CompleteRequest(requestId) {
        $.ajax({
            url: '/RequestHistory/CompleteRequest',
            type: 'POST',
            data: { requestId: requestId },
            success: function () {
                alert("تم اكمال الخدمة بنجاح.");
                filterRequests(); // Refresh the list
            },
            error: function () {
                alert("There was an error in the request.");
            }
        });
    }

</script>

@section CustomerProfile {
    <link rel="stylesheet" href="~/css/CustomerProfile.css" />

}
@*
<div>
    <label for="statusDropdown">Select Status</label>
    <select id="statusDropdown" name="selectedStatus" onchange="filterRequests()">
        <option value="">---- Select Status ----</option>
        @foreach (var status in ViewBag.StatusList)
        {
            <option value="@status.Value">@status.Text</option>
        }
    </select>
</div>
<div>
    <button onclick="resetFilters()">Show All Requests</button>
</div>
<div>
    <h4>Request History</h4>
    <div id="requestHistory"></div>
</div>
<div>
    <button id="prevPage" onclick="prevPage()" disabled>Previous</button>
    <span id="pageInfo">Page 1</span>
    <button id="nextPage" onclick="nextPage()">Next</button>
</div>
*@