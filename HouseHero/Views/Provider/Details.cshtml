@model ProviderWithAllDataViewModel

@{
    ViewData["Title"] = "Details";
    Layout = "_ProviderLayout";
}

<div class="page">
    <div class="sidebar-container">
        <aside class="sidebar">
            <div class="side-btn">
                <a asp-controller="Provider" asp-action="RequestService" asp-route-id="@Model.ProviderId">اطلب خدمتك الان</a>
            </div>
            <p class="side-title">مواعيد العمل</p>
            <div class="calendar">
                <table>
                    @foreach (var day in Model.Days)
                    {
                        <tr>
                            <td>@day.Day</td>
                            <td>@day.Start_Time.ToString("hh:mm tt")</td>
                            <td>@day.End_Time.ToString("hh:mm tt")</td>
                        </tr>
                    }
                </table>
            </div>
            <p class="side-price">متوسط سعر الخدمة @Html.DisplayFor(model => model.MinPrice) : @Html.DisplayFor(model => model.MaxPrice) جنيه</p>
        </aside>
    </div>

    <div class="page-content">
        <div class="section">
            <div class="profile">
                <div class="mydata">
                    <img src="./Images/ProfilePic.png" class="profile-pic" />
                    <div class="profile-info">
                        <h6>@Html.DisplayFor(model => model.ProviderName)</h6>
                        <p class="rating">
                            <i class="fa-solid fa-star"></i> @Html.DisplayFor(model => model.Rating)
                            <!-- <span>(150 تقييماً)</span> -->
                        </p>
                        <p class="city">
                            @Html.DisplayFor(model => model.ServiceName)
                        </p>
                    </div>
                </div>

                <div class="profile-optn">
                    <a href="javascript:void(0);" class="settings" onclick="saveProvider()">
                        <i id="bookmarkIcon" class="@((Model.Save) ? "fa-solid fa-bookmark" : "fa-regular fa-bookmark")" style="margin-left: 75px;"></i>
                    </a>
                    @* Hidden field to hold the Save state for server use *@
                    @Html.HiddenFor(model => model.Save, new { @id = "saveState" })
                </div>

            </div>

            <div class="bio">
                <p class="head">نبذة عني</p>
                <p class="bio-content">
                    @Html.DisplayFor(model => model.Bio)
                </p>
            </div>
        </div>

        <hr class="divider" />

        <div class="section">
            <div class="head">
                <p>صور لبعض خدماتنا</p>
            </div>
            <div class="gallery">

                @*static*@
                <div class="album">
                    <div class="picpic">
                        <img src="/assets/ServiceSelection/اعطال منزلية.png" alt="" class="gallery-img" />
                    </div>
                    <div class="description">
                        وصف وصف وصف وصفوصف وصف وصف وصف وصف وصف وصف وصف وصف وصف وصف وصف وصف وصف وصف وصف وصف
                    </div>
                </div>

            </div>
        </div>

        <hr class="divider" />

        <div class="section">
            <div class="head">
                <p>التعليقات</p>
            </div>

            <div class="comments-section">

                <form id="addReviewForm" asp-action="SaveReview" method="post" onsubmit="return addReview(event)">
                    <input type="hidden" name="ProviderId" value="@Model.ProviderId" />
                    <input type="hidden" name="CustomerId" value="@ViewBag.CustomerId" />
                    <div class="comment">
                        <div class="my-comment-topside">
                            <div class="my-data">
                                <img src="/assets/Home/emptyIcon.png" class="my-pic" />
                            </div>
                            <div class="textboxCon">
                                <textarea rows="3"
                                          type="text"
                                          class="textbox"
                                          id="Comment"
                                          name="Comment"
                                          placeholder="اضف تعليقاً...." ></textarea>
                            </div>

                            <div class="dropdown">
                                <select id="Rating" name="Rating">
                                    <option value="" hidden selected disabled>تقييم</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                            <button class="send-comment" type="submit">تعليق</button>
                        </div>
                    </div>
                </form>
                <div class="container">
                    <div class="posted-comments border p-3" id="reviewsSection" style="height: 150px; overflow-y: auto;">
                    @foreach (var review in Model.Reviews)
                    {
                        <div class="comment">
                            <div class="comment-topside">
                                <div class="user-data">
                                    <img src="./Images/ProfilePic.png" class="user-pic" />
                                    <div class="user-info">
                                        <p class="user-name">
                                            @review.Customer?.ApplicationUser?.UserName
                                        </p>
                                    </div>
                                </div>
                                <div class="user-rating">
                                    <i class="fa-solid fa-star"></i> @review.Rating
                                </div>
                            </div>

                            <p class="the-comment">
                                @review.Comment
                            </p>
                        </div>

                        <hr class="divider" />
                    }
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="saveModalLabel"  aria-hidden="true">
    <div class="modal-dialog" style="
    position: fixed;
    bottom: 10px;
    right: 10px;
    border-radius:15px;
    margin: 0;
    width: auto; 
    max-width: 500px; 
" role="document">
        <div class="modal-content ">
            <div class="modal-header">
                <h5 class="modal-title" id="saveModalLabel">رسالة</h5>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>
</div>



<script>
    function saveProvider() {
        var icon = document.getElementById('bookmarkIcon');
        var isSaved = icon.classList.contains("fa-solid"); // Determine if it’s currently saved
        var providerId = '@Model.ProviderId';
        var customerId = '@ViewBag.CustomerId';
        var providerName = '@Model.ProviderName';

        // Toggle icon class to represent save/unsave
        if (isSaved) {
            icon.classList.remove("fa-solid");
            icon.classList.add("fa-regular");
            document.getElementById('saveState').value = false; // Update hidden field
        } else {
            icon.classList.remove("fa-regular");
            icon.classList.add("fa-solid");
            document.getElementById('saveState').value = true; // Update hidden field
        }

        $.ajax({
            url: '@Url.Action("SavedProvider", "Provider")',
            type: 'POST',
            data: {
                customerId: customerId,
                providerId: providerId,
                isSaved: !isSaved // Pass the updated save state
            },
            success: function (response) {
                var message = !isSaved
                    ? " تم حفظ " + providerName + " بنجاح"
                    : "تم حذف " + providerName + " بنجاح";
                $('.modal-body').text(message);
                $('#saveModal').modal('show');

                setTimeout(function () {
                    $('#saveModal').modal('hide');
                }, 1500);
            },
            error: function (xhr, status, error) {
                console.error("An error occurred while saving the state.");
            }
        });
    }


    function addReview(event) {
        event.preventDefault();

        var form = $('#addReviewForm');
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            success: function (response) {
                // Append the new review to the reviews section dynamically
                $('#reviewsSection').append(
                    `<div class="comment">
                    <div class="comment-topside">
                      <div class="user-data">
                        <div class="user-info">
                          <p class="user-name">
                              ${response.customerName}
                          </p>
                        </div>
                      </div>
                      <div class="user-rating">
                        <i class="fa-solid fa-star"></i>${response.rating}
                      </div>
                    </div>
                    <p class="the-comment">
                        ${response.comment}
                    </p>
                  </div>`
                );
                form[0].reset(); // Clear the form after submission
            },
            error: function (xhr, status, error) {
                console.error("An error occurred while adding the review.");
            }
        });

        return false;
    }

    // Optionally trigger save before user leaves the page
    // window.onbeforeunload = function () {
    //     saveProvider();
    // };
</script>

@section Provider {
    <link href="~/css/Provider.css" rel="stylesheet" />
}
@section ModalValid {
    <!-- Include Bootstrap and jQuery (necessary for the modal) -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
}


@*

        <dd class="col-sm-10">
            <ul>
                @foreach (var day in Model.Days)
                {
                    <li>
                        <strong>Day:</strong> @day.Day <br />
                        <strong>Start Time:</strong> @day.Start_Time.ToString("hh:mm tt") <br />
                        <strong>End Time:</strong> @day.End_Time.ToString("hh:mm tt")
                    </li>
                }
            </ul>
        </dd>
        <!-- Reviews Section -->
        <div class="container">
            <h4>Reviews</h4>
            <div id="reviewsSection" class="border p-3" style="height: 100px; overflow-y: auto;">
                @foreach (var review in Model.Reviews)
                {
                    <div class="review mb-2">
                        <p><strong>Customer:</strong> @review.Customer?.ApplicationUser?.UserName</p>
                        <p><strong>Comment:</strong> @review.Comment</p>
                        <p><strong>Rating:</strong> @review.Rating</p>
                    </div>
                    <hr />
                }
            </div>
        </div>
        
        <!-- Add Review Form -->
        <form id="addReviewForm" asp-action="SaveReview" method="post" onsubmit="return addReview(event)">
            <input type="hidden" name="ProviderId" value="@Model.ProviderId" />
            <input type="hidden" name="CustomerId" value="@ViewBag.CustomerId" />

            <div class="form-group">
                <label for="Comment">Comment</label>
                <textarea class="form-control" id="Comment" name="Comment" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="Rating">Rating (1-5)</label>
                <select class="form-control" id="Rating" name="Rating">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Submit</button>
        </form>

        <dt>
            <a asp-controller="Provider" asp-action="RequestService" asp-route-id="@Model.ProviderId" class="text-decoration-none"> اطلب الخدمة الان</a>
        </dt>
    </dl>
</div>
<div>
    <a asp-controller="Category" asp-action="GetAll">Back to List</a>
</div>


<div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="saveModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveModalLabel">Notification</h5>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>
</div>


<script>
    function saveProvider() {
        var isChecked = document.getElementById('saveCheckbox').checked;
        var providerId = '@Model.ProviderId';
        var customerId = '@ViewBag.CustomerId';
        var providerName = '@Model.ProviderName';

        $.ajax({
            url: '@Url.Action("SavedProvider", "Provider")',
            type: 'POST',
            data: {
                customerId: customerId,
                providerId: providerId,
                isSaved: isChecked
            },
            success: function (response) {
                var message = isChecked
                    ? providerName + " has been saved successfully!"
                    : providerName + " has been removed from the saved list!";
                $('.modal-body').text(message);
                $('#saveModal').modal('show');

                setTimeout(function () {
                    $('#saveModal').modal('hide');
                }, 1500);
            },
            error: function (xhr, status, error) {
                console.error("An error occurred while saving the state.");
            }
        });
    }
    function addReview(event) {
        event.preventDefault();

        var form = $('#addReviewForm');
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            success: function (response) {
                // Append the new review to the reviews section dynamically
                $('#reviewsSection').append(
                    `<div class="review">
                                <p><strong>Customer:</strong> ${response.customerName}</p>
                                <p><strong>Comment:</strong> ${response.comment}</p>
                                <p><strong>Rating:</strong> ${response.rating}</p>
                                <hr />
                            </div>`
                );
                form[0].reset(); // Clear the form after submission
            },
            error: function (xhr, status, error) {
                console.error("An error occurred while adding the review.");
            }
        });

        return false;
    }

    // Optionally trigger save before user leaves the page
    // window.onbeforeunload = function () {
    //     saveProvider();
    // };
</script>

@section ModalValid {
    <!-- Include Bootstrap and jQuery (necessary for the modal) -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
}

*@
